<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy"
content="
default-src 'self';
script-src 'self';
style-src 'self' 'unsafe-inline';
img-src 'self' data:;
connect-src 'none';
font-src 'none';
object-src 'none';
media-src 'none';
base-uri 'none';
form-action 'none';
frame-ancestors 'none';
upgrade-insecure-requests;
">
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KrySearch</title>
<style>
body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#0a0a0a;color:#fff;font-family:system-ui,sans-serif}
.box{width:100%;max-width:420px;padding:32px;border-radius:16px;background:#121212;text-align:center;box-shadow:0 0 20px rgba(0,0,0,.6)}
input{width:100%;padding:14px;border-radius:10px;border:none;background:#1c1c1c;color:#fff;font-size:1rem;outline:none}
button{width:100%;margin-top:14px;padding:14px;border-radius:10px;border:none;background:#4da6ff;color:#000;font-weight:800;cursor:pointer}
button:hover{background:#3399ff}
.meta{margin-top:12px;font-size:.75rem;opacity:.55}
</style>
</head>
<body>
<div class="box">
<h1>KrySearch</h1>
<input id="q" placeholder="Search or HTTPS/.onion URL" autocomplete="off" spellcheck="false">
<button id="go">Go</button>
<div class="meta" id="status"></div>
</div>
<script>
/* ===== STRICT PRIVACY ===== */
for(const k of['localStorage','sessionStorage','indexedDB']) try{Object.defineProperty(window,k,{value:null})}catch{}
document.cookie.split(';').forEach(c=>document.cookie=c.replace(/^ +/,'').replace(/=.*/,'=;expires=Thu,01 Jan 1970 00:00:00 UTC;path=/'))
if(location.protocol!=='https:'&&location.hostname!=='localhost') location.replace('https://'+location.host+location.pathname)
if(top!==self) document.documentElement.innerHTML=''

/* ===== TOR DETECTION ===== */
const isTor = navigator.userAgent.includes('Tor Browser')||(navigator.platform==='Linux x86_64'&&navigator.doNotTrack==='1')
document.getElementById('status').textContent = isTor ? 'Tor detected Â· Onion enabled' : 'Clear-net mode'

/* ===== ENGINES ===== */
const clearnet = [
  q=>`https://www.startpage.com/sp/search?query=${q}`,
  q=>`https://duckduckgo.com/?q=${q}&kl=wt-wt`
]
const onion = [
  q=>`http://startpage.onion/sp/search?query=${q}`,
  q=>`http://duckduckgogg42xjoc72x3sjasowoarfbgcmvfimaftt6twagswzczad.onion/?q=${q}`
]

/* ===== FINGERPRINT DEFENSE ===== */
const jitter = () => new Promise(r => setTimeout(r, Math.random()*160+80))
const _getContext = HTMLCanvasElement.prototype.getContext
HTMLCanvasElement.prototype.getContext = function(t){
  const ctx = _getContext.call(this,t)
  if(t==='2d'){const g=ctx.getImageData;ctx.getImageData=function(){
    const d=g.apply(this,arguments)
    for(let i=0;i<32;i++){const p=Math.floor(Math.random()*d.data.length);d.data[p]^=1}
    return d
  }}
  return ctx
}
Object.defineProperty(document,'fonts',{value:null})

/* ===== SEARCH LOGIC ===== */
function launch(url){window.location.href=url}

// Auto-launch from query parameters
const params = new URLSearchParams(window.location.search)
let inputParam = params.get('url') || params.get('q')
if(inputParam){
  try{inputParam = decodeURIComponent(inputParam)}catch{}
  const u = inputParam.trim()
  if(/^https?:\/\//i.test(u) || /\.onion/i.test(u)) launch(u)
}

// Normal search input (ignored if ?url or ?q exists)
document.getElementById('go').onclick = async () => {
  if(inputParam) return
  const v = document.getElementById('q').value.trim()
  if(!v) return
  await jitter()
  if(/^http:\/\//i.test(v)) return
  if(/^(https:\/\/|http:\/\/.*\.onion)/i.test(v)){ launch(v); return }
  const q = encodeURIComponent(v)
  const engines = isTor ? onion : clearnet
  const engine = engines[Math.floor(Math.random()*engines.length)]
  launch(engine(q))
}
</script>
</body>
</html>
